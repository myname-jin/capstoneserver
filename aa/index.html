<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë°œí‘œ ì˜ìƒ ë¶„ì„ (ì‹¤ì‹œê°„ UI)</title>
  <style>
    :root { --bg:#f6f8fa; --card:#fff; --mono:ui-monospace, SFMono-Regular, Menlo, monospace; --bar:#e5e7eb; --fill:#3b82f6; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); margin:0; }
    .wrap { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    .card { background: var(--card); border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,.06); padding: 20px; }
    .row { display: grid; grid-template-columns: 1.15fr .85fr; gap: 16px; }
    video { width: 100%; max-height: 520px; background:#000; border-radius: 10px; }
    .controls { display:flex; flex-wrap:wrap; gap:8px; margin:8px 0 12px; }
    button, label.btn { padding:10px 14px; border:1px solid #e2e8f0; border-radius:8px; background:#fff; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    input[type=file]{ display:none; }
    .badge { display:inline-block; padding:4px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:600; }
    .kpi { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .k { border:1px solid #e5e7eb; border-radius:10px; padding:12px; }
    .k h4 { margin:0 0 4px; font-size:14px; color:#334155; display:flex; justify-content:space-between; }
    .bar { width:100%; height:10px; background:var(--bar); border-radius:999px; overflow:hidden; }
    .fill { height:100%; background:var(--fill); width:0%; }
    .num { font-family: var(--mono); color:#111827; }
    .muted { color:#64748b; font-size:.92rem; }
    .panel { border:1px solid #e5e7eb; border-radius:10px; padding:12px; }
    .log { font-family: var(--mono); background:#0b1220; color:#c7ffb8; border-radius:8px; padding:12px; max-height:240px; overflow:auto; white-space:pre-wrap; }
    .log.error { background:#fff0f0; color:#b40000; }
    .grid3 { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; }
    .toggle { margin:8px 0 0; display:flex; align-items:center; gap:8px; }
    table { width:100%; border-collapse:collapse; font-family:var(--mono); }
    td { padding:4px 6px; border-bottom:1px dashed #e5e7eb; font-size:12px; }
    td.r { text-align:right; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ë°œí‘œ ì˜ìƒ ë¶„ì„ (ì›¹ìº /íŒŒì¼) Â· ì‹¤ì‹œê°„ í‘œì •Â·ì‹œì„  UI</h1>

    <div class="controls">
      <button id="useCam">ğŸ“· ì›¹ìº  ì‚¬ìš©</button>
      <label for="file" class="btn">ğŸï¸ íŒŒì¼ ì„ íƒ</label>
      <input id="file" type="file" accept="video/*">
      <button id="start" disabled>â–¶ï¸ ë¶„ì„ ì‹œì‘</button>
      <button id="stop" disabled>â¹ï¸ ì •ì§€</button>
      <span id="status" class="badge">ëŒ€ê¸°</span>
    </div>

    <div class="row">
      <div>
        <video id="video" playsinline muted controls></video>
        <div class="grid3" style="margin-top:12px">
          <div class="panel">
            <div style="font-weight:700">í˜„ì¬ í‘œì •</div>
            <div id="expr" style="font-size:1.4rem;margin-top:4px">â€”</div>
            <div id="exprDetail" class="muted">ê·œì¹™ ê¸°ë°˜ ë¶„ë¥˜â€¦</div>
          </div>
          <div class="panel">
            <div style="font-weight:700">í˜„ì¬ ì‹œì„ </div>
            <div id="gaze" style="font-size:1.4rem;margin-top:4px">â€”</div>
            <div id="gazeDetail" class="muted">(ì¢Œ/ìš°/ìƒ/í•˜/ëŒ€ê°/ì •ë©´)</div>
          </div>
          <div class="panel">
            <div style="font-weight:700">í”„ë ˆì„</div>
            <div style="font-size:1.4rem;margin-top:4px"><span id="time">0.00</span>s</div>
            <div class="muted" id="mode">ë™ê¸°í™”: â€”</div>
          </div>
        </div>
      </div>

      <div>
        <div class="panel">
          <div style="font-weight:700;margin-bottom:8px">ì‹¤ì‹œê°„ í•µì‹¬ ì§€í‘œ</div>
          <div class="kpi">
            <div class="k"><h4>Smile <span class="num" id="n_smile">0.000</span></h4><div class="bar"><div id="b_smile" class="fill"></div></div></div>
            <div class="k"><h4>Frown <span class="num" id="n_frown">0.000</span></h4><div class="bar"><div id="b_frown" class="fill"></div></div></div>
            <div class="k"><h4>BrowUp <span class="num" id="n_browUp">0.000</span></h4><div class="bar"><div id="b_browUp" class="fill"></div></div></div>
            <div class="k"><h4>BrowDown <span class="num" id="n_browDn">0.000</span></h4><div class="bar"><div id="b_browDn" class="fill"></div></div></div>
            <div class="k"><h4>JawOpen <span class="num" id="n_jaw">0.000</span></h4><div class="bar"><div id="b_jaw" class="fill"></div></div></div>
            <div class="k"><h4>MouthOpen <span class="num" id="n_mouth">0.000</span></h4><div class="bar"><div id="b_mouth" class="fill"></div></div></div>
            <div class="k"><h4>Squint <span class="num" id="n_squint">0.000</span></h4><div class="bar"><div id="b_squint" class="fill"></div></div></div>
            <div class="k"><h4>Gaze H <span class="num" id="n_gH">0.000</span></h4><div class="bar"><div id="b_gH" class="fill"></div></div></div>
            <div class="k"><h4>Gaze V <span class="num" id="n_gV">0.000</span></h4><div class="bar"><div id="b_gV" class="fill"></div></div></div>
          </div>

          <label class="toggle"><input type="checkbox" id="toggleTop"> Top-10 ë¸”ë Œë“œì…°ì´í”„ ë³´ê¸°</label>
          <div id="topWrap" style="display:none; margin-top:8px">
            <table id="topTable"></table>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="panel">
            <div style="font-weight:700;margin-bottom:8px">ë¡œê·¸</div>
            <div id="log" class="log">ì›¹ìº /íŒŒì¼ ì„ íƒ â†’ â–¶ï¸ ë¶„ì„ ì‹œì‘</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script type="module">
  import { FaceLandmarker, FilesetResolver }
    from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/vision_bundle.js";

  // DOM refs
  const video = document.getElementById('video');
  const btnCam = document.getElementById('useCam');
  const inpFile = document.getElementById('file');
  const btnStart = document.getElementById('start');
  const btnStop = document.getElementById('stop');
  const statusEl = document.getElementById('status');
  const logEl = document.getElementById('log');
  const exprEl = document.getElementById('expr');
  const exprDetailEl = document.getElementById('exprDetail');
  const gazeEl = document.getElementById('gaze');
  const gazeDetailEl = document.getElementById('gazeDetail');
  const timeEl = document.getElementById('time');
  const modeEl = document.getElementById('mode');
  const toggleTop = document.getElementById('toggleTop');
  const topWrap = document.getElementById('topWrap');
  const topTable = document.getElementById('topTable');

  const bars = {
    smile:  document.getElementById('b_smile'),
    frown:  document.getElementById('b_frown'),
    browUp: document.getElementById('b_browUp'),
    browDn: document.getElementById('b_browDn'),
    jaw:    document.getElementById('b_jaw'),
    mouth:  document.getElementById('b_mouth'),
    squint: document.getElementById('b_squint'),
    gH:     document.getElementById('b_gH'),
    gV:     document.getElementById('b_gV'),
  };
  const nums = {
    smile:  document.getElementById('n_smile'),
    frown:  document.getElementById('n_frown'),
    browUp: document.getElementById('n_browUp'),
    browDn: document.getElementById('n_browDn'),
    jaw:    document.getElementById('n_jaw'),
    mouth:  document.getElementById('n_mouth'),
    squint: document.getElementById('n_squint'),
    gH:     document.getElementById('n_gH'),
    gV:     document.getElementById('n_gV'),
  };

  // State
  let faceLandmarker = null;
  let running = false;
  let srcType = null; // cam | file
  let usingRVFC = false;
  let lastVideoTime = -1;
  let objectUrl = null;

  // EMA
  const smooth = {};
  const ALPHA = 0.5;
  const ema = (k, v) => (smooth[k] = (smooth[k] ?? v) * (1-ALPHA) + v*ALPHA);

  // Init
  init();
  async function init(){
    setStatus('ëª¨ë¸ ë¡œë”©â€¦');
    const fileset = await FilesetResolver.forVisionTasks(
      "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
    );
    faceLandmarker = await FaceLandmarker.createFromOptions(fileset, {
      baseOptions: {
        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
        delegate: "CPU",
      },
      runningMode: "VIDEO",
      numFaces: 1,
      minFaceDetectionConfidence: 0.3,
      minTrackingConfidence: 0.3,
      outputFaceBlendshapes: true,
    });
    setStatus('ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ');
    btnStart.disabled = false;
  }

  // Inputs
  btnCam.onclick = async () => {
    cleanupFileUrl();
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      video.srcObject = stream; srcType = 'cam';
      await waitMeta(); info("ì›¹ìº  ì—°ê²° ì„±ê³µ. â–¶ ë¶„ì„ ì‹œì‘");
      btnStart.disabled = false;
    } catch(e){ error("ì›¹ìº  ì‹¤íŒ¨: " + e.message); }
  };

  inpFile.onchange = async (e) => {
    const file = e.target.files?.[0]; if(!file) return;
    info(`íŒŒì¼: ${file.name} / ${file.type || 'type?'} / ${(file.size/1024/1024).toFixed(1)}MB`);
    cleanupFileUrl();
    objectUrl = URL.createObjectURL(file);
    video.srcObject = null;
    video.muted = true; video.setAttribute('playsinline','');
    video.src = objectUrl; srcType = 'file';
    attachDebugOnce();
    await waitMeta();
    info(`ë©”íƒ€ë°ì´í„° OK: ${video.videoWidth}x${video.videoHeight}, ${video.duration.toFixed(2)}s`);
    try { await video.play(); video.pause(); info('í”„ë¦¬ë·° ë Œë” OK'); } catch { info('ì¬ìƒ ë²„íŠ¼ì„ í•œë²ˆ ëˆŒëŸ¬ì£¼ì„¸ìš”'); }
    btnStart.disabled = false;
  };

  function waitMeta(){
    return new Promise((res, rej)=>{
      const onOk = () => { video.currentTime = 0; res(); };
      const onErr = () => rej(new Error('metadata error'));
      video.addEventListener('loadedmetadata', onOk, {once:true});
      video.addEventListener('error', onErr, {once:true});
    });
  }

  // Start/Stop
  btnStart.onclick = async () => {
    if(!faceLandmarker) return error('ëª¨ë¸ ë¯¸ì¤€ë¹„');
    if(!video.srcObject && !video.src) return error('ì…ë ¥ ì„ íƒ í•„ìš”');

    try { await video.play(); } catch { info('ì¬ìƒ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”'); }
    running = true; btnStart.disabled = true; btnStop.disabled = false;
    setStatus('ë¶„ì„ ì¤‘');

    if ('requestVideoFrameCallback' in HTMLVideoElement.prototype) {
      usingRVFC = true; modeEl.textContent = 'ë™ê¸°í™”: RVFC';
      video.requestVideoFrameCallback(onFrame);
    } else {
      usingRVFC = false; modeEl.textContent = 'ë™ê¸°í™”: rAF';
      requestAnimationFrame(loopRAF);
    }
  };
  btnStop.onclick = () => {
    running = false; setStatus('ì •ì§€'); btnStop.disabled = true; btnStart.disabled = false;
    if (srcType === 'file') video.pause();
  };

  // Loops
  function onFrame(){ if(!running) return;
    if(video.readyState >= 2){ const t = video.currentTime; timeEl.textContent = t.toFixed(2); runOnce(t); }
    video.requestVideoFrameCallback(onFrame);
  }
  function loopRAF(){ if(!running) return;
    if(video.readyState >= 2){ const t = video.currentTime;
      if (t !== lastVideoTime){ timeEl.textContent = t.toFixed(2); runOnce(t); lastVideoTime = t; }
    } requestAnimationFrame(loopRAF);
  }

  // One frame
  function runOnce(t){
    try{
      const ts = Math.round(t*1000);
      const r = faceLandmarker.detectForVideo(video, ts);
      const hasFace = (r.faceLandmarks?.length ?? 0) > 0;
      if(!hasFace){ setExpr('â€”','ì–¼êµ´ ë¯¸ê²€ì¶œ'); setGaze('â€”','ì–¼êµ´ ë¯¸ê²€ì¶œ'); return; }

      const cats = r.faceBlendshapes?.[0]?.categories ?? [];
      const pick = (n) => cats.find(c => c.categoryName===n)?.score ?? 0;

      // metrics (EMA)
      const smile  = ema('smile',  (pick('mouthSmileLeft') + pick('mouthSmileRight'))/2);
      const frown  = ema('frown',  (pick('mouthFrownLeft') + pick('mouthFrownRight'))/2);
      const browUp = ema('browUp', (pick('browInnerUp') + pick('browOuterUpLeft') + pick('browOuterUpRight'))/3);
      const browDn = ema('browDn', (pick('browDownLeft') + pick('browDownRight'))/2);
      const jaw    = ema('jaw',    pick('jawOpen') || pick('jawDrop') || 0);
      const mouth  = ema('mouth',  pick('mouthOpen') || 0);
      const squint = ema('squint', (pick('eyeSquintLeft') + pick('eyeSquintRight'))/2);

      // gaze (EMA) â€” subject-centric
      const hLeft  = pick('eyeLookOutLeft') - pick('eyeLookInLeft');
      const hRight = pick('eyeLookInRight') - pick('eyeLookOutRight');
      const vLeft  = pick('eyeLookUpLeft')  - pick('eyeLookDownLeft');
      const vRight = pick('eyeLookUpRight') - pick('eyeLookDownRight');
      const gH     = ema('gH', (hLeft+hRight)/2);
      const gV     = ema('gV', (vLeft+vRight)/2);

      // update gauges
      setGauge('smile', smile); setGauge('frown', frown);
      setGauge('browUp', browUp); setGauge('browDn', browDn);
      setGauge('jaw', jaw); setGauge('mouth', mouth); setGauge('squint', squint);
      setGaugeSigned('gH', gH); setGaugeSigned('gV', gV);

      // labels
      const TH = { smile:0.25, frown:0.25, browDn:0.20, browUp:0.25, surpriseJ:0.35, surpriseM:0.35 };
      let exprLabel='ğŸ˜ Neutral', why=[];
      if (jaw>TH.surpriseJ && mouth>TH.surpriseM && browUp>TH.browUp){ exprLabel='ğŸ˜® Surprise'; why.push(`jaw ${f3(jaw)}, mouth ${f3(mouth)}, browUp ${f3(browUp)}`);}
      else if (smile>TH.smile && browUp>0.15){ exprLabel='ğŸ˜Š Smile'; why.push(`smile ${f3(smile)}, browUp ${f3(browUp)}`);}
      else if ((frown>TH.frown && browDn>TH.browDn) || (frown>TH.frown && squint>0.2)){ exprLabel='ğŸ˜  Angry'; why.push(`frown ${f3(frown)}, browDown ${f3(browDn)}${squint>0.2?`, squint ${f3(squint)}`:''}`);}
      setExpr(exprLabel, why.join(' | ')||'ê·œì¹™ ì¼ì¹˜ ì•½í•¨');

      const GH=0.12, GV=0.12;
      let gazeLabel='ì •ë©´';
      if (Math.abs(gH)<GH && Math.abs(gV)<GV) gazeLabel='ì •ë©´';
      else {
        const horiz = gH>GH?'ì¢Œ':(gH<-GH?'ìš°':'');
        const vert  = gV>GV?'ìƒ':(gV<-GV?'í•˜':'');
        gazeLabel = (vert+horiz) || (horiz||vert);
      }
      setGaze(gazeLabel, `h=${f2(gH)}, v=${f2(gV)} (í”¼ì‚¬ì²´ ê¸°ì¤€)`);

      // top-10 blendshapes (optional)
      if (toggleTop.checked) {
        const top = [...cats].sort((a,b)=>b.score-a.score).slice(0,10);
        topTable.innerHTML = top.map(x=>`<tr><td>${x.categoryName}</td><td class="r">${x.score.toFixed(3)}</td></tr>`).join('');
      }
    } catch(e){ error('ë¶„ì„ ì˜¤ë¥˜: '+e.message); running=false; btnStart.disabled=false; btnStop.disabled=true; }
  }

  // UI helpers
  function setGauge(key, v){ nums[key].textContent=f3(v); bars[key].style.width=(Math.max(0,Math.min(1,v))*100).toFixed(0)+'%'; }
  // for signed gaze: map -1..1 â†’ 0..100 with 50 as center
  function setGaugeSigned(key, v){ nums[key].textContent=f3(v); bars[key].style.width=((v*0.5+0.5)*100).toFixed(0)+'%'; }
  function setExpr(t,d=''){ exprEl.textContent=t; exprDetailEl.textContent=d; }
  function setGaze(t,d=''){ gazeEl.textContent=t; gazeDetailEl.textContent=d; }
  function write(msg){ logEl.classList.remove('error'); logEl.textContent = msg + "\n" + logEl.textContent; }
  function info(m){ write('â„¹ï¸ '+m); }
  function error(m){ logEl.classList.add('error'); logEl.textContent='âŒ '+m+"\n"+logEl.textContent; setStatus('ì—ëŸ¬'); }
  function setStatus(s){ statusEl.textContent=s; }
  function cleanupFileUrl(){ if(objectUrl){ URL.revokeObjectURL(objectUrl); objectUrl=null; } }
  function f3(x){ return (x??0).toFixed(3); } function f2(x){ return (x??0).toFixed(2); }

  // debug video events (1íšŒë§Œ)
  let dbg=false;
  function attachDebugOnce(){ if(dbg) return; dbg=true;
    ['loadedmetadata','loadeddata','canplay','canplaythrough','playing','pause','stalled','suspend','waiting','emptied','abort','error','ended','timeupdate','seeking','seeked']
      .forEach(ev=>video.addEventListener(ev, ()=>write(`ğŸ¬ [${ev}] t=${(video.currentTime||0).toFixed(2)}s rs=${video.readyState} vw=${video.videoWidth} vh=${video.videoHeight}`)));
  }
  window.onerror=(m,s,l)=>error(`${m} (${s?.split('/').pop()}:${l})`);

  // top toggle
  toggleTop.addEventListener('change', ()=> topWrap.style.display = toggleTop.checked ? 'block':'none' );
</script>
</body>
</html>
