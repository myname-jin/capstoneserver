<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°œí‘œ ì˜ìƒ AI ë¶„ì„ê¸°</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --bg:#f6f8fa; --card:#fff; --mono:ui-monospace, SFMono-Regular, Menlo, monospace; --bar:#e5e7eb; --fill:#3b82f6; }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: #333; max-width: 1200px; margin: 20px auto; padding: 0 20px; line-height: 1.6; }
        h1 { color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .card { background: var(--card); border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,.06); padding: 25px; margin-top: 20px; }
        
        .layout-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 20px; margin-top: 20px; }
        form { display: flex; flex-direction: column; gap: 15px; }
        input[type="file"] { padding: 10px; border: 2px dashed #ddd; border-radius: 5px; cursor: pointer; }
        button { background-color: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #2980b9; }

        #loading { display: none; text-align: center; font-weight: bold; color: #555; }
        #loading-text { font-size: 1.1em; color: #34495e; margin-top: 10px; }
        
        #transcript-report { display: none; }
        #ai-report-placeholder {
            background: #fdfdfd; padding: 0 20px; border-radius: 5px; 
            border-bottom: 1px dashed #ccc; margin-bottom: 15px;
        }
        #ai-report-placeholder h1, #ai-report-placeholder h2 { border-bottom: 1px solid #eee; }
        #transcript-content { background-color: #fdfdfd; border: 1px solid #eee; border-radius: 5px; padding: 20px; max-height: 800px; overflow-y: auto; }
        #transcript-content .segment {
            padding: 10px; border-radius: 5px; margin-bottom: 8px;
            cursor: pointer; transition: background-color 0.2s;
        }
        #transcript-content .segment:hover { background-color: #f0f4f8; }
        #transcript-content .segment.active { background-color: #ddeafe; border-left: 4px solid #3b82f6; }
        #transcript-content .segment-time { font-family: var(--mono); font-size: 0.9em; color: #64748b; }
        #transcript-content .segment-text { font-size: 1.1em; margin: 4px 0; }
        
        #segment-popover {
            display: none; position: absolute; background: #333; color: white;
            padding: 15px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 100; width: 280px; font-size: 0.95em;
        }
        #segment-popover h4 { margin: 0 0 10px; padding-bottom: 5px; border-bottom: 1px solid #555; }
        #segment-popover .pop-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        
        .error { color: #e74c3c; font-weight: bold; }

        #playback-ui { display: none; }
        video { width: 100%; max-height: 520px; background:#000; border-radius: 10px; margin-bottom: 15px; }
        .panel { border:1px solid #e5e7eb; border-radius:10px; padding:12px; }
        .grid3 { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; margin-bottom: 12px; }
        .kpi { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .k { border:1px solid #e5e7eb; border-radius:10px; padding:12px; }
        .k h4 { margin:0 0 4px; font-size:14px; color:#334155; display:flex; justify-content:space-between; }
        .bar { width:100%; height:10px; background:var(--bar); border-radius:999px; overflow:hidden; }
        .fill { height:100%; background:var(--fill); width:0%; transition: width 0.1s linear; }
        
        /* â­ï¸ [ì¶”ê°€] Jitter/Shimmerìš© ê²½ê³ ìƒ‰ ë°” */
        .bar.warn { --bar:#fef3c7; } 
        .fill.warn { --fill:#f59e0b; }

        .num { font-family: var(--mono); color:#111827; }
        .muted { color:#64748b; font-size:.92rem; }
        
        .toggle { margin:15px 0 8px; display:flex; align-items:center; gap:8px; cursor: pointer; }
        table { width:100%; border-collapse:collapse; font-family:var(--mono); }
        td { padding:4px 6px; border-bottom:1px dashed #e5e7eb; font-size:12px; }
        td.r { text-align:right; color:#000; font-weight: 500;}

        /* â­ï¸ [ì‹ ê·œ] ì±„ì  ê¸°ì¤€ UI ìŠ¤íƒ€ì¼ */
        .criteria-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fcfcfc;
        }
        .criteria-row input[type="text"],
        .criteria-row input[type="number"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-grow: 1;
        }
        .criteria-row input[name="criteria-name"] {
            flex-grow: 1;
        }
        .criteria-row input[name="criteria-desc"] {
            flex-grow: 3;
        }
        .criteria-row input[name="criteria-score"] {
            width: 70px;
            flex-grow: 0;
            text-align: right;
        }
        .criteria-row button {
            padding: 8px 12px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        #addCriteriaButton {
            background-color: #2ecc71;
            margin-top: 10px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        .input-group input[type="text"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        /* ë„ë„› ì°¨íŠ¸ ìŠ¤íƒ€ì¼ */
        #donut-chart-container {
            position: relative;
            margin: 20px 0;
        }
        #donut-overlay-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer;
        }
        #detail-display-container {
            background-color: #fdfdfd; 
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 20px; /* ìƒì„¸ í”¼ë“œë°± ì˜ì—­ íŒ¨ë”© ì¶”ê°€ */
        }
        /* AI ë³´ê³ ì„œ í…ìŠ¤íŠ¸ ì˜ì—­ (ë„ë„› ì°¨íŠ¸ê°€ ë³´ì¼ ë•ŒëŠ” ìˆ¨ê¹€) */
        #ai-report-placeholder {
            display: none; /* ì‹œì‘ ì‹œ ìˆ¨ê¹€ */
        }
        
    </style>
</head>
<body>

    <h1>ğŸ¬ ë°œí‘œ ì˜ìƒ AI ë¶„ì„ê¸°</h1>
    
    <div class="card">
        <h3>1. ë¶„ì„í•  ë™ì˜ìƒ íŒŒì¼ ì—…ë¡œë“œ</h3>
        <form id="uploadForm">
            <input type="file" id="videoFile" name="videoFile" accept="video/*" required>

            <div class="card" style="margin-top: 0; box-shadow: none; border: 1px solid #e0e0e0; padding-bottom: 15px;">
                <h4>2. ğŸ“ í‰ê°€ ì •ë³´ ì…ë ¥ (í•„ìˆ˜)</h4>
                <div class="input-group">
                    <input type="text" id="competitionName" name="competitionName" placeholder="ëŒ€íšŒ/ìˆ˜ì—…ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 2025 AI ê²½ì§„ëŒ€íšŒ)" required>
                    <input type="text" id="teamName" name="teamName" placeholder="íŒ€ëª… ë˜ëŠ” ë°œí‘œì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 4ì¡°)" required>
                </div>
            </div>

            <div class="card" style="margin-top: 0; box-shadow: none; border: 1px solid #e0e0e0;">
                <h4>3. ğŸ“Š AI ì±„ì  ê¸°ì¤€ ì„¤ì • (1ê°œ ~ ìµœëŒ€ 5ê°œ)</h4>
                <div id="criteriaContainer">
                    </div>
                <button type="button" id="addCriteriaButton">â• ì±„ì  ê¸°ì¤€ ì¶”ê°€ (ìµœëŒ€ 5ê°œ)</button>
                <small style="color: #666; display: block; margin-top: 10px;">* ê¸°ë³¸ 3ê°€ì§€ ê¸°ì¤€ì€ ìë™ìœ¼ë¡œ ì±„ì›Œì§€ë©°, ì‚­ì œ í›„ ìµœëŒ€ 5ê°œê¹Œì§€ ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
            </div>
            
            <input type="hidden" id="criteriaJson" name="criteriaJson">
            
            <button type="submit" id="submitButton">AI ë¶„ì„ ì‹œì‘</button>
        </form>
    </div>

    <div id="loading" class="card">
        <p>ğŸ¤– AIê°€ ë™ì˜ìƒì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
        <p id="loading-text">ì„œë²„ì— ì‘ì—… ìš”ì²­ ì¤‘...</p>
    </div>

    <div class="layout-grid">
        
        <div id="playback-ui" class="card">
            <h2>ğŸï¸ ë¶„ì„ ì˜ìƒ ì¬ìƒ</h2>
            <video id="video" controls muted></video>
            <div class="grid3">
                <div class="panel">
                    <div style="font-weight:700">í˜„ì¬ í‘œì •</div>
                    <div id="expr" style="font-size:1.4rem;margin-top:4px">â€”</div>
                    <div id="exprDetail" class="muted">ê·œì¹™ ê¸°ë°˜ ë¶„ë¥˜â€¦</div>
                </div>
                <div class="panel">
                    <div style="font-weight:700">í˜„ì¬ ì‹œì„ </div>
                    <div id="gaze" style="font-size:1.4rem;margin-top:4px">â€”</div>
                    <div id="gazeDetail" class="muted">(ì¢Œ/ìš°/ìƒ/í•˜/ì •ë©´)</div>
                </div>
                <div class="panel">
                    <div style="font-weight:700">í”„ë ˆì„</div>
                    <div style="font-size:1.4rem;margin-top:4px"><span id="time">0.00</span>s</div>
                    <div class="muted">ë¶„ì„ ë°ì´í„° ë™ê¸°í™”</div>
                </div>
            </div>
            <div class="panel" style="margin-top: 15px;">
                <div style="font-weight:700;margin-bottom:8px">ì‹¤ì‹œê°„ í•µì‹¬ ì§€í‘œ</div>
                <div class="kpi">
                    <div class="k"><h4>Smile <span class="num" id="n_smile">0.00</span></h4><div class="bar"><div id="b_smile" class="fill"></div></div></div>
                    <div class="k"><h4>Frown <span class="num" id="n_frown">0.00</span></h4><div class="bar"><div id="b_frown" class="fill"></div></div></div>
                    <div class="k"><h4>BrowUp <span class="num" id="n_brow_up">0.00</span></h4><div class="bar"><div id="b_brow_up" class="fill"></div></div></div>
                    <div class="k"><h4>BrowDown <span class="num" id="n_brow_down">0.00</span></h4><div class="bar"><div id="b_brow_down" class="fill"></div></div></div>
                    <div class="k"><h4>JawOpen <span class="num" id="n_jaw_open">0.00</span></h4><div class="bar"><div id="b_jaw_open" class="fill"></div></div></div>
                    <div class="k"><h4>MouthOpen <span class="num" id="n_mouth_open">0.00</span></h4><div class="bar"><div id="b_mouth_open" class="fill"></div></div></div>
                    <div class="k"><h4>Squint <span class="num" id="n_squint">0.00</span></h4><div class="bar"><div id="b_squint" class="fill"></div></div></div>
                    <div class="k"><h4>Gaze H <span class="num" id="n_gaze_h">0.00</span></h4><div class="bar"><div id="b_gaze_h" class="fill"></div></div></div>
                    <div class="k"><h4>Gaze V <span class="num" id="n_gaze_v">0.00</span></h4><div class="bar"><div id="b_gaze_v" class="fill"></div></div></div>
                    
                    <div class="k">
                        <h4>Jitter (ë–¨ë¦¼) <span class="num" id="n_jitter">0.00%</span></h4>
                        <div class="bar warn"><div id="b_jitter" class="fill warn"></div></div>
                    </div>
                    <div class="k">
                        <h4>Shimmer (ê±°ì¹ ê¸°) <span class="num" id="n_shimmer">0.00%</span></h4>
                        <div class="bar warn"><div id="b_shimmer" class="fill warn"></div></div>
                    </div>
                </div>
            </div>
            <label class="toggle"><input type="checkbox" id="toggleTop"> Top-10 ë¸”ë Œë“œì…°ì´í”„ ë³´ê¸°</label>
            <div id="topWrap" style="display:none; margin-top:8px" class="panel">
                <table id="topTable"></table>
            </div>
        </div>

        <div id="transcript-report" class="card">
            <h2>ğŸ“œ ëŒ€ë³¸ ë° êµ¬ê°„ ë¶„ì„</h2>
            
            <div id="score-visualization-area">
                <div id="overall-score-display" style="cursor: pointer; font-size: 1.5em; font-weight: bold; margin: 20px 0; text-align: center;"></div>
                <div id="donut-chart-container" style="display: flex; justify-content: center; align-items: center; min-height: 300px; position: relative;">
                    <svg id="donutChart" width="300" height="300" style="display: none;"></svg>
                    <div id="donut-overlay-text"></div>
                </div>
                
                <div id="detail-display-container" style="display: none; text-align: left; padding: 20px; border-radius: 8px;">
                    <button id="backButton" type="button" style="background-color: #555; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">
                        â† ë„ë„› ì°¨íŠ¸ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                    <div id="detail-content" style="white-space: pre-wrap; color: black;"></div>
                </div>
            </div>

            <div id="ai-report-placeholder"></div>
            <div id="transcript-content"></div>
        </div>
    </div>

    <div id="segment-popover">
        <div id="popover-content"></div>
    </div>


    <script>
        // DOM ìš”ì†Œ ìºì‹±
        const uploadForm = document.getElementById('uploadForm');
        const submitButton = document.getElementById('submitButton');
        const videoFile = document.getElementById('videoFile');
        const loadingDiv = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const aiReportDiv = document.getElementById('transcript-report');
        const aiReportPlaceholder = document.getElementById('ai-report-placeholder');
        const transcriptContent = document.getElementById('transcript-content');
        const playbackUiDiv = document.getElementById('playback-ui');
        const video = document.getElementById('video');
        const competitionNameInput = document.getElementById('competitionName');
        const teamNameInput = document.getElementById('teamName');
        const criteriaContainer = document.getElementById('criteriaContainer'); 
        const addCriteriaButton = document.getElementById('addCriteriaButton');
        const criteriaJsonInput = document.getElementById('criteriaJson');
        const timeEl = document.getElementById('time');
        const exprEl = document.getElementById('expr');
        const exprDetailEl = document.getElementById('exprDetail');
        const gazeEl = document.getElementById('gaze');
        const gazeDetailEl = document.getElementById('gazeDetail');
        const toggleTop = document.getElementById('toggleTop');
        const topWrap = document.getElementById('topWrap');
        const topTable = document.getElementById('topTable');
        const popover = document.getElementById('segment-popover');
        const popoverContent = document.getElementById('popover-content');
        
        // â­ï¸ ë„ë„› ì°¨íŠ¸ ê´€ë ¨ DOM ìš”ì†Œ
        const scoreVisualizationArea = document.getElementById('score-visualization-area');
        const donutChart = document.getElementById('donutChart');
        const donutOverlayText = document.getElementById('donut-overlay-text');
        const overallScoreDisplay = document.getElementById('overall-score-display');
        const detailDisplayContainer = document.getElementById('detail-display-container');
        const detailContent = document.getElementById('detail-content');
        const backButton = document.getElementById('backButton');


        const bars = {
            smile: document.getElementById('b_smile'), frown: document.getElementById('b_frown'),
            brow_up: document.getElementById('b_brow_up'), brow_down: document.getElementById('b_brow_down'),
            jaw_open: document.getElementById('b_jaw_open'), mouth_open: document.getElementById('b_mouth_open'),
            squint: document.getElementById('b_squint'), gaze_h: document.getElementById('b_gaze_h'),
            gaze_v: document.getElementById('b_gaze_v'),
            jitter: document.getElementById('b_jitter'),
            shimmer: document.getElementById('b_shimmer'),
        };
        const nums = {
            smile: document.getElementById('n_smile'), frown: document.getElementById('n_frown'),
            brow_up: document.getElementById('n_brow_up'), brow_down: document.getElementById('n_brow_down'),
            jaw_open: document.getElementById('n_jaw_open'), mouth_open: document.getElementById('n_mouth_open'),
            squint: document.getElementById('n_squint'), gaze_h: document.getElementById('n_gaze_h'),
            gaze_v: document.getElementById('n_gaze_v'),
            jitter: document.getElementById('n_jitter'),
            shimmer: document.getElementById('n_shimmer'),
        };

        let rawData = [];
        let alignedTranscriptData = [];
        let videoObjectUrl = null;
        let pollingInterval = null;

        // â­ï¸ [í•µì‹¬] DOMContentLoaded ì´í›„ì— ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.addEventListener('DOMContentLoaded', () => {
            
            // â­ï¸ [ì‹ ê·œ] ê¸°ë³¸ ì±„ì  ê¸°ì¤€ ì´ˆê¸°í™” ë° ê´€ë¦¬ ë¡œì§
            const MAX_CRITERIA = 5;
            let criteriaCount = 0; 

            function addCriteriaRow(name = '', description = '', score = 10, isInitial = false) {
                if (criteriaCount >= MAX_CRITERIA) {
                    if (!isInitial) {
                        alert(`ì±„ì  ê¸°ì¤€ì€ ìµœëŒ€ ${MAX_CRITERIA}ê°œê¹Œì§€ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                    }
                    return;
                }

                const wrapper = document.createElement('div');
                wrapper.className = 'criteria-row';
                wrapper.dataset.index = criteriaCount;

                wrapper.innerHTML = `
                    <input type="text" name="criteria-name" placeholder="ê¸°ì¤€ëª… (ì˜ˆ: ì°½ì˜ë ¥)" value="${name}" required>
                    <input type="text" name="criteria-desc" placeholder="ê¸°ì¤€ ì„¤ëª… (GPTê°€ ì±„ì í•  ë•Œ ì°¸ê³ )" value="${description}" required>
                    <input type="number" name="criteria-score" placeholder="ë§Œì  ê¸°ì¤€" value="${score}" min="1" max="100" required>
                    ${isInitial ? '' : '<button type="button" class="remove-criteria-btn">ì‚­ì œ</button>'}
                `;

                criteriaContainer.appendChild(wrapper);
                criteriaCount++;
                updateCriteriaButtonState();
                
                // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                if (!isInitial) {
                    wrapper.querySelector('.remove-criteria-btn').addEventListener('click', (e) => {
                        criteriaContainer.removeChild(wrapper);
                        criteriaCount--;
                        updateCriteriaButtonState();
                        e.stopPropagation(); 
                    });
                }
            }
            
            function updateCriteriaButtonState() {
                addCriteriaButton.disabled = criteriaCount >= MAX_CRITERIA;
                addCriteriaButton.textContent = criteriaCount >= MAX_CRITERIA ? `ìµœëŒ€ ${MAX_CRITERIA}ê°œ ì„¤ì •ë¨` : 'â• ì±„ì  ê¸°ì¤€ ì¶”ê°€ (ìµœëŒ€ 5ê°œ)';
            }

            // â­ï¸ [ìˆ˜ì •] ì´ˆê¸° ê¸°ì¤€ ì„¤ì •: í˜ì´ì§€ ë¡œë“œ ì‹œ 1ê°œë§Œ í‘œì‹œ
            addCriteriaRow('ì‹œì„  ì²˜ë¦¬', 'gaze_h/vê°€ -0.1~0.1 ì‚¬ì´ì¸ ì •ë©´ ì‘ì‹œ ë¹„ìœ¨ì„ í‰ê°€', 25, true);
            
            // â­ï¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°: ë²„íŠ¼ í´ë¦­ ì‹œ ìƒˆë¡œìš´ ë¹ˆ í•­ëª© ì¶”ê°€
            addCriteriaButton.addEventListener('click', () => {
                // ë²„íŠ¼ í´ë¦­ ì‹œ ë¯¸ë¦¬ ì±„ì›Œì§„ ë°ì´í„° ì—†ì´ ë¹ˆ í•­ëª© ì¶”ê°€
                addCriteriaRow('', '', 10, false); 
            });
            
            // â­ï¸ [ì‹ ê·œ] í¼ ì œì¶œ ì‹œ ê¸°ì¤€ ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ìˆ¨ê²¨ì§„ í•„ë“œì— ì €ì¥
            function collectCriteriaData() {
                const criteria = [];
                const rows = criteriaContainer.querySelectorAll('.criteria-row');
                rows.forEach(row => {
                    const name = row.querySelector('input[name="criteria-name"]').value.trim();
                    const desc = row.querySelector('input[name="criteria-desc"]').value.trim();
                    let score = parseInt(row.querySelector('input[name="criteria-score"]').value);
                    
                    if (name && desc && !isNaN(score) && score > 0) {
                        score = Math.min(100, Math.max(1, score));
                        criteria.push({ name: name, description: desc, score: score });
                    }
                });
                
                criteriaJsonInput.value = criteria.length > 0 ? JSON.stringify(criteria) : "";
            }


            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
            uploadForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                // â­ï¸ 1. ê¸°ì¤€ ë°ì´í„° ë° í•„ìˆ˜ ì…ë ¥ ê°’ í™•ì¸
                collectCriteriaData();
                
                if (!competitionNameInput.value.trim()) { alert('ëŒ€íšŒ/ìˆ˜ì—…ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                if (!teamNameInput.value.trim()) { alert('íŒ€ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                const file = videoFile.files[0];
                if (!file) { alert('ë™ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
                
                const formData = new FormData();
                formData.append('videoFile', file);
                // â­ï¸ 2. ëŒ€íšŒëª…, íŒ€ëª…, JSON ê¸°ì¤€ì„ FormDataì— ì¶”ê°€
                formData.append('competitionName', competitionNameInput.value.trim());
                formData.append('teamName', teamNameInput.value.trim());
                formData.append('criteriaJson', criteriaJsonInput.value); 
                
                setLoadingState(true, '0/6: ì„œë²„ì— ì‘ì—… ìš”ì²­ ì¤‘...'); 
                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData,
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        try { const errorJson = JSON.parse(errorText); throw new Error(errorJson.detail || 'ì„œë²„ ì—…ë¡œë“œ ì‹¤íŒ¨'); } 
                        catch (e) { throw new Error(errorText || 'ì„œë²„ ì—…ë¡œë“œ ì‹¤íŒ¨'); }
                    }

                    const data = await response.json();
                    if (!data.job_id) {
                        throw new Error('ì„œë²„ì—ì„œ ì‘ì—… IDë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    }
                    pollStatus(data.job_id, file);

                } catch (error) {
                    console.error('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                    showError(`âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
                }
            });
        }); // DOMContentLoaded ë


        // Polling í•¨ìˆ˜ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
        function pollStatus(jobId, file) {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/status/${jobId}`);

                    if (!response.ok) {
                        const errorText = await response.text();
                        try { const errorJson = JSON.parse(errorText); throw new Error(errorJson.detail || `ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨: ${response.statusText}`); } 
                        catch (e) { throw new Error(errorText || `ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨: ${response.statusText}`); }
                    }

                    const data = await response.json();

                    let progressMessage = `ğŸ¤– ${data.message}`;
                    if (data.progress && data.total) {
                        progressMessage += ` (${data.progress}/${data.total} í”„ë ˆì„)`;
                    }
                    loadingText.textContent = progressMessage;

                    if (data.status === 'Complete' || data.status === 'Error') {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        showResults(data.result, file);
                    }
                } catch (error) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    console.error('Polling ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                    showError(`âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                }
            }, 2000);
        }

        // â­ï¸ [í•µì‹¬] ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜ - ë„ë„› ì°¨íŠ¸ ë¡œì§ í¬í•¨
        function showResults(data, file) {
            // 1. AI ë©”ì‹œì§€ í‘œì‹œ ë° ë°ì´í„° ì¶”ì¶œ
            if (data.ai_assessment && (data.ai_assessment.ai_feedback || data.ai_assessment.error)) {
                const message = data.ai_assessment.ai_feedback || `<p class="error">${data.ai_assessment.error}</p>`;
                
                // AI ë³´ê³ ì„œ í…ìŠ¤íŠ¸ íŒŒì‹±
                const criteriaData = parseCriteriaFeedback(data.ai_assessment.ai_feedback);
                const currentTotalScore = criteriaData.reduce((sum, item) => sum + item.score, 0);
                const totalPossibleScore = criteriaData.reduce((sum, item) => sum + item.max_score, 0);
                const overallFeedbackText = parseOverallFeedback(data.ai_assessment.ai_feedback);
                
                // 3. ë„ë„› ì°¨íŠ¸ ê·¸ë¦¬ê¸° ì‹œì‘
                drawDonutChart(criteriaData, currentTotalScore, totalPossibleScore, overallFeedbackText);
                
                // AI ë³´ê³ ì„œ í…ìŠ¤íŠ¸ëŠ” ë„ë„› ì°¨íŠ¸ê°€ ë³´ì¼ ë•Œ ìˆ¨ê¸°ê¸° ìœ„í•´ ì—¬ê¸°ì„œë§Œ íŒŒì‹±í•˜ê³ , í‘œì‹œ ì—¬ë¶€ëŠ” ì°¨íŠ¸ í•¨ìˆ˜ê°€ ê²°ì •
                aiReportPlaceholder.innerHTML = marked.parse(message);
                aiReportPlaceholder.style.display = 'none'; // ì‹œì‘ ì‹œ ë„ë„› ì°¨íŠ¸ë¥¼ ë³´ì—¬ì£¼ê¸° ìœ„í•´ í…ìŠ¤íŠ¸ ìˆ¨ê¹€
                
            } else {
                aiReportPlaceholder.innerHTML = `<p class="error">âŒ AI ë¶„ì„ ê²°ê³¼ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>`;
                aiReportPlaceholder.style.display = 'block';
            }
            

            // 2. í”„ë ˆì„ë³„ ì‹œì„ /í‘œì • ë°ì´í„° ì €ì¥ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            if (data.raw_data && data.raw_data.length > 0) {
                rawData = data.raw_data.filter(d => !d.error);
            } else {
                aiReportPlaceholder.innerHTML += `<p class="error">âŒ ì›ë³¸ ë°ì´í„°(raw_data)ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
            }
            
            // 3. ëŒ€ë³¸(Transcript) UI ìƒì„± (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            transcriptContent.innerHTML = ''; 
            if (data.aligned_transcript_data && data.aligned_transcript_data.length > 0) {
                alignedTranscriptData = data.aligned_transcript_data;
                alignedTranscriptData.forEach((segment, index) => {
                    const segmentEl = document.createElement('div');
                    segmentEl.className = 'segment';
                    segmentEl.dataset.index = index;
                    segmentEl.dataset.start = segment.start;
                    
                    segmentEl.innerHTML = `
                        <div class="segment-time">${segment.start.toFixed(1)}s - ${segment.end.toFixed(1)}s</div>
                        <div class="segment-text">${segment.text}</div>
                    `;
                    
                    segmentEl.addEventListener('click', () => {
                        video.currentTime = segment.start;
                        video.play();
                    });
                    segmentEl.addEventListener('mouseenter', (e) => showPopover(e, segment));
                    segmentEl.addEventListener('mouseleave', () => popover.style.display = 'none');

                    transcriptContent.appendChild(segmentEl);
                });
            } else if (!data.ai_assessment.error) {
                transcriptContent.innerHTML = `<p style="color:#777; font-style: italic;">ìŒì„± ì¸ì‹ ê²°ê³¼(ëŒ€ë³¸)ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }

            // 4. ë¹„ë””ì˜¤ ì¬ìƒ ì¤€ë¹„
            if (videoObjectUrl) URL.revokeObjectURL(videoObjectUrl);
            videoObjectUrl = URL.createObjectURL(file);
            video.src = videoObjectUrl;

            // 5. UI í‘œì‹œ
            setLoadingState(false, '');
            aiReportDiv.style.display = 'block';
            playbackUiDiv.style.display = 'block';
        }

        // â­ï¸ [ì‹ ê·œ] GPT ì‘ë‹µì—ì„œ í•­ëª©ë³„ ì ìˆ˜ì™€ í”¼ë“œë°±ì„ íŒŒì‹±í•˜ëŠ” í•¨ìˆ˜
        function parseCriteriaFeedback(rawText) {
            const result = [];
            
            const criteriaRegex = /\d+\. \*\*(.*?)\*\* \((\d+)ì \):([\s\S]*?)(?=\n\s*\d+\. \*\*|\n\n\d+\. \*\*ì¢…í•© ì ìˆ˜)/g;
            criteriaRegex.lastIndex = 0; 

            let match;
            while ((match = criteriaRegex.exec(rawText)) !== null) {
                const [section, name, maxScoreStr, feedbackContent] = match;
                
                const scoreMatch = section.match(/ì ìˆ˜: (\d+)ì  \(\d+ì  ë§Œì  ì¤‘\)/);
                
                if (scoreMatch) {
                    const score = parseInt(scoreMatch[1]);
                    const maxScore = parseInt(maxScoreStr); 
                    const feedback = feedbackContent.substring(0, feedbackContent.indexOf('ì ìˆ˜:')).trim();
                    
                    result.push({
                        name: name.trim(),
                        score: score,
                        max_score: maxScore,
                        feedback: feedback
                    });
                }
            }
            // âš ï¸ íŒŒì‹±ì´ ì‹¤íŒ¨í•  ê²½ìš°, ë””ë²„ê¹…ì„ ìœ„í•´ ì„ì‹œ Mock Dataë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
            if (result.length === 0) {
                 return [
                    { name: 'ì‹œì„  ì²˜ë¦¬', score: 10, max_score: 25, feedback: "GPT ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: ì„ì‹œ ë°ì´í„°ì…ë‹ˆë‹¤. ì‹¤ì œ ì‘ë‹µì— ì ìˆ˜ í˜•ì‹ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤." },
                    { name: 'í‘œì • ê´€ë¦¬', score: 15, max_score: 25, feedback: "GPT ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: ì„ì‹œ ë°ì´í„°ì…ë‹ˆë‹¤. ì‹¤ì œ ì‘ë‹µì— ì ìˆ˜ í˜•ì‹ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤." },
                    { name: 'ì „ë‹¬ë ¥', score: 30, max_score: 50, feedback: "GPT ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: ì„ì‹œ ë°ì´í„°ì…ë‹ˆë‹¤. ì‹¤ì œ ì‘ë‹µì— ì ìˆ˜ í˜•ì‹ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤." },
                ];
            }
            return result;
        }

        // â­ï¸ [ì‹ ê·œ] GPT ì‘ë‹µì—ì„œ ì¢…í•© ì ìˆ˜ ë° ì´í‰ì„ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
        function parseOverallFeedback(rawText) {
            const overallMatch = rawText.match(/\*\*ì¢…í•© ì ìˆ˜ ë° ì´í‰\*\*:([\s\S]*?)(?=\n\s*\d+\. \*\*ì˜ìƒìš”ì•½)/s);
            return overallMatch ? overallMatch[1].trim() : "ì¢…í•© í”¼ë“œë°± í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        }

        // â­ï¸ [ì‹ ê·œ] SVG ë„ë„› ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜
        function drawDonutChart(criteriaData, currentTotalScore, totalPossibleScore, overallFeedbackText) {
            donutChart.style.display = 'block';
            detailDisplayContainer.style.display = 'none';
            donutChart.innerHTML = '';
            donutOverlayText.innerHTML = '';
            
            let accumulatedAngle = 0;
            const radius = 100;
            const centerX = 150;
            const centerY = 150;
            const innerRadius = 60;
            const colors = ['#3b82f6', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6'];
            
            // 1. ì´ì  í‘œì‹œ ì—…ë°ì´íŠ¸ (ì°¨íŠ¸ ìœ„ì— í‘œì‹œ)
            overallScoreDisplay.innerHTML = `ì´ì : <span style="font-size: 1.2em; color: #2ecc71;">${currentTotalScore}/${totalPossibleScore}</span>`;
            
            // 2. ì°¨íŠ¸ ë°ì´í„° ê³„ì‚° ë° ê·¸ë¦¬ê¸°
            criteriaData.forEach((data, index) => {
                // ë§Œì  ë¹„ì¤‘ì— ë”°ë¼ ì „ì²´ ì˜ì—­ì„ ë‚˜ëˆ•ë‹ˆë‹¤.
                const proportion = data.max_score / totalPossibleScore; 
                const angle = 360 * proportion;
                const nextAngle = accumulatedAngle + angle;
                
                // íšë“ ì ìˆ˜ ë¹„ìœ¨ (ë§Œì  ëŒ€ë¹„ ì‹¤ì œë¡œ íšë“í•œ ì ìˆ˜ì˜ ë¹„ìœ¨)
                const scoreRatio = data.score / data.max_score; 
                
                // Path ê³„ì‚°
                const startAngleRad = Math.PI * 2 * accumulatedAngle / 360;
                const endAngleRad = Math.PI * 2 * nextAngle / 360;

                const startX = centerX + radius * Math.sin(startAngleRad);
                const startY = centerY - radius * Math.cos(startAngleRad);
                const endX = centerX + radius * Math.sin(endAngleRad);
                const endY = centerY - radius * Math.cos(endAngleRad);
                
                const largeArcFlag = angle > 180 ? 1 : 0;
                
                // â­ï¸ í•­ëª©ì˜ ì „ì²´ ë§Œì  ì˜ì—­ (ì˜…ì€ ìƒ‰)
                const totalPathData = [
                    `M ${centerX} ${centerY}`,
                    `L ${startX} ${startY}`,
                    `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${endX} ${endY}`,
                    `Z`
                ].join(' ');
                
                const totalPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                totalPath.setAttribute('d', totalPathData);
                totalPath.setAttribute('fill', '#ddd'); // ì˜…ì€ íšŒìƒ‰ìœ¼ë¡œ ë§Œì  ì˜ì—­ í‘œì‹œ
                totalPath.style.cursor = 'pointer';
                donutChart.appendChild(totalPath);
                
                // â­ï¸ íšë“ ì ìˆ˜ ì˜ì—­ (ì§„í•œ ìƒ‰, ë§Œì  ì˜ì—­ ìœ„ì— ë§ê·¸ë¦¼)
                if (scoreRatio > 0) {
                    const scoreAngle = angle * Math.min(scoreRatio, 1); // 100%ê¹Œì§€ë§Œ ì±„ìš°ê¸°
                    const scoreNextAngleRad = Math.PI * 2 * (accumulatedAngle + scoreAngle) / 360;
                    
                    const scoreEndX = centerX + radius * Math.sin(scoreNextAngleRad);
                    const scoreEndY = centerY - radius * Math.cos(scoreNextAngleRad);
                    
                    const scoreLargeArcFlag = scoreAngle > 180 ? 1 : 0;

                    const scorePathData = [
                        `M ${centerX} ${centerY}`,
                        `L ${startX} ${startY}`,
                        `A ${radius} ${radius} 0 ${scoreLargeArcFlag} 1 ${scoreEndX} ${scoreEndY}`,
                        `Z`
                    ].join(' ');
                    
                    const scorePath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    scorePath.setAttribute('d', scorePathData);
                    scorePath.setAttribute('fill', colors[index % colors.length]);
                    scorePath.style.cursor = 'pointer';
                    
                    // â­ï¸ í•­ëª©ë³„ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                    scorePath.addEventListener('click', () => showDetail('criteria', data));
                    
                    donutChart.appendChild(scorePath);
                }
                
                // â­ï¸ í…ìŠ¤íŠ¸ ë ˆì´ë¸” (í•­ëª© ì´ë¦„ ë° íšë“ ì ìˆ˜)
                const textAngle = accumulatedAngle + angle / 2;
                const textDistance = radius * 1.15; 
                const textX = centerX + textDistance * Math.sin(Math.PI * 2 * textAngle / 360);
                const textY = centerY - textDistance * Math.cos(Math.PI * 2 * textAngle / 360);
                
                const textElement = document.createElementNS("http://www.w3.org/2000/svg", "text");
                textElement.setAttribute('x', textX);
                textElement.setAttribute('y', textY); 
                textElement.setAttribute('fill', 'black');
                textElement.setAttribute('text-anchor', 'middle');
                textElement.setAttribute('font-size', '12');
                
                // í…ìŠ¤íŠ¸ ë‚´ìš©: í•­ëª©ëª… + ì ìˆ˜
                textElement.innerHTML = `<tspan x="${textX}" dy="0" font-weight="bold">${data.name}</tspan>` + 
                                        `<tspan x="${textX}" dy="15">${data.score} / ${data.max_score}</tspan>`;
                
                donutChart.appendChild(textElement);

                accumulatedAngle = nextAngle;
            });
            
            // ê°€ìš´ë° í°ìƒ‰ ì› (ë„ë„› íš¨ê³¼)
            const centerCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            centerCircle.setAttribute('cx', centerX);
            centerCircle.setAttribute('cy', centerY);
            centerCircle.setAttribute('r', innerRadius);
            centerCircle.setAttribute('fill', 'white');
            donutChart.appendChild(centerCircle);
            
            // â­ï¸ ì´ì  ì˜¤ë²„ë ˆì´ í…ìŠ¤íŠ¸ ì¶”ê°€
            donutOverlayText.innerHTML = `<span style="font-size: 0.9em; color: black; line-height: 1.2;">ì´ì </span><br><span style="font-size: 1.5em; color: #333;">${currentTotalScore}</span>`;
            donutOverlayText.style.cursor = 'pointer';
            
            // â­ï¸ ì´ì  í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²° (í´ë¦­ ì‹œ ì¢…í•© ì´í‰ í‘œì‹œ)
            donutOverlayText.onclick = () => showDetail('overall', { score: currentTotalScore, max_score: totalPossibleScore, feedback: overallFeedbackText });
            
            // â­ï¸ í•­ëª©ë³„ ì œëª© ì˜†ì— 'ë„ë„› ë³´ê¸°' ë²„íŠ¼ ìƒì„± (AI ë³´ê³ ì„œ ì˜ì—­ íŒŒì‹±)
            document.querySelectorAll('#ai-report-placeholder h3, #ai-report-placeholder h2').forEach(heading => {
                const text = heading.textContent;
                // '1. ì‹œì„  ì²˜ë¦¬ (25ì ):' íŒ¨í„´ì„ ì°¾ìŠµë‹ˆë‹¤.
                if (text.match(/\d+\. .*? \(\d+ì \):/)) {
                    const button = document.createElement('button');
                    button.textContent = 'ë„ë„› ë³´ê¸°';
                    button.style.cssText = 'margin-left: 10px; padding: 4px 8px; font-size: 0.8em; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;';
                    button.onclick = () => {
                        scoreVisualizationArea.style.display = 'block';
                        detailDisplayContainer.style.display = 'none';
                        aiReportPlaceholder.style.display = 'none';
                    };
                    
                    heading.appendChild(button);
                }
            });
            // ì´ˆê¸° ë¡œë“œ ì‹œ GPT ë³´ê³ ì„œëŠ” ë³´ì´ì§€ë§Œ ì°¨íŠ¸ ì˜ì—­ì€ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤.
            scoreVisualizationArea.style.display = 'block';
            aiReportPlaceholder.style.display = 'none';
        }

        // â­ï¸ [ì‹ ê·œ] ìƒì„¸ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
        function showDetail(type, data) {
            scoreVisualizationArea.style.display = 'none';
            detailDisplayContainer.style.display = 'block';
            aiReportPlaceholder.style.display = 'none'; 
            
            detailDisplayContainer.style.backgroundColor = 'white';
            
            if (type === 'overall') {
                detailContent.innerHTML = `
                    <h3 style="color: black;">ì¢…í•© ì ìˆ˜ ë° ì´í‰</h3>
                    <p style="margin-bottom: 20px; color: black;">
                        ì´ì : <b>${data.score}/${data.max_score}</b>ì 
                    </p>
                    <div style="color: black;">${marked.parse(data.feedback)}</div>
                `;
            } else if (type === 'criteria') {
                detailContent.innerHTML = `
                    <h3 style="color: black;">${data.name} ì±„ì  ê²°ê³¼ (${data.score}/${data.max_score})</h3>
                    <div style="color: black;">${marked.parse(data.feedback)}</div>
                    <div style="color: #666; margin-top: 15px;">* ì´ ìƒì„¸ ë‚´ìš©ì€ GPTê°€ íŒŒì‹±í•œ í•­ëª©ë³„ í”¼ë“œë°±ì…ë‹ˆë‹¤.</div>
                `;
            }
        }
        
        // â­ï¸ [ì‹ ê·œ] ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        backButton.addEventListener('click', () => {
            scoreVisualizationArea.style.display = 'block';
            detailDisplayContainer.style.display = 'none';
            // GPT ë³´ê³ ì„œ í…ìŠ¤íŠ¸ ì˜ì—­ì„ ë‹¤ì‹œ ë³´ì´ê²Œ í•©ë‹ˆë‹¤.
            aiReportPlaceholder.style.display = 'none';
        });

        // Polling í•¨ìˆ˜ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
        function pollStatus(jobId, file) {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/status/${jobId}`);

                    if (!response.ok) {
                        const errorText = await response.text();
                        try { const errorJson = JSON.parse(errorText); throw new Error(errorJson.detail || `ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨: ${response.statusText}`); } 
                        catch (e) { throw new Error(errorText || `ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨: ${response.statusText}`); }
                    }

                    const data = await response.json();

                    let progressMessage = `ğŸ¤– ${data.message}`;
                    if (data.progress && data.total) {
                        progressMessage += ` (${data.progress}/${data.total} í”„ë ˆì„)`;
                    }
                    loadingText.textContent = progressMessage;

                    if (data.status === 'Complete' || data.status === 'Error') {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        showResults(data.result, file);
                    }
                } catch (error) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    console.error('Polling ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                    showError(`âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                }
            }, 2000);
        }

        // í—¬í¼ í•¨ìˆ˜: ë‚˜ë¨¸ì§€ ë¡œì§ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        
        function updateAllGauges(frame) {
            document.getElementById('n_smile').textContent = frame.smile.toFixed(3);
            document.getElementById('b_smile').style.width = (Math.max(0, Math.min(1, frame.smile)) * 100).toFixed(0) + '%';
            
            setGauge('smile', frame.smile);
            setGauge('frown', frame.frown);
            setGauge('brow_up', frame.brow_up);
            setGauge('brow_down', frame.brow_down);
            setGauge('jaw_open', frame.jaw_open);
            setGauge('mouth_open', frame.mouth_open);
            setGauge('squint', frame.squint);
            setGaugeSigned('gaze_h', frame.gaze_h);
            setGaugeSigned('gaze_v', frame.gaze_v);
        }

        function updateTop10(blendshapes) {
            const topTable = document.getElementById('topTable');
            if (!blendshapes) {
                topTable.innerHTML = '';
                return;
            }
            const entries = Object.keys(blendshapes).map(key => ({ name: key, score: blendshapes[key] }));
            entries.sort((a, b) => b.score - a.score);
            const top10 = entries.slice(0, 10);
            topTable.innerHTML = top10.map(item => 
                `<tr><td>${item.name}</td><td class="r">${item.score.toFixed(3)}</td></tr>`
            ).join('');
        }

        function setLoadingState(isLoading, message) {
            submitButton.disabled = isLoading;
            submitButton.textContent = isLoading ? 'ë¶„ì„ ì¤‘...' : 'AI ë¶„ì„ ì‹œì‘';
            document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
            document.getElementById('loading-text').textContent = message;
            
            if (isLoading) {
                document.getElementById('transcript-report').style.display = 'none';
                document.getElementById('playback-ui').style.display = 'none';
                document.getElementById('ai-report-placeholder').innerHTML = '';
                document.getElementById('transcript-content').innerHTML = '';
                rawData = [];
                alignedTranscriptData = [];
                if (pollingInterval) clearInterval(pollingInterval);
            }
        }

        function findClosestFrame(currentTime) {
            if (rawData.length === 0) return null;
            return rawData.reduce((prev, curr) => {
                return (Math.abs(curr.time - currentTime) < Math.abs(prev.time - currentTime) ? curr : prev);
            });
        }
        
        function updateTranscriptAndProsodyHighlight(currentTime) {
            if (alignedTranscriptData.length === 0) return;

            const segments = document.querySelectorAll('.segment');
            let currentActiveSegment = null;
            
            for (const segmentEl of segments) {
                const index = segmentEl.dataset.index;
                if (!alignedTranscriptData[index]) continue;
                
                const start = parseFloat(segmentEl.dataset.start);
                const end = parseFloat(alignedTranscriptData[index].end);
                
                if (currentTime >= start && currentTime <= end) {
                    currentActiveSegment = segmentEl;
                    break;
                }
            }
            
            if (currentActiveSegment !== lastActiveSegment) {
                if (lastActiveSegment) lastActiveSegment.classList.remove('active');
                
                if (currentActiveSegment) {
                    currentActiveSegment.classList.add('active');
                    
                    const segmentData = alignedTranscriptData[currentActiveSegment.dataset.index];
                    if (segmentData && segmentData.prosody) {
                        setGauge('jitter', segmentData.prosody.jitter / 2.0); 
                        setGauge('shimmer', segmentData.prosody.shimmer / 5.0);
                        nums['jitter'].textContent = segmentData.prosody.jitter.toFixed(2) + '%';
                        nums['shimmer'].textContent = segmentData.prosody.shimmer.toFixed(2) + '%';
                    }
                } else {
                    setGauge('jitter', 0);
                    setGauge('shimmer', 0);
                    nums['jitter'].textContent = '0.00%';
                    nums['shimmer'].textContent = '0.00%';
                }
                lastActiveSegment = currentActiveSegment;
            }
        }
        
        function showPopover(event, segment) {
            const popover = document.getElementById('segment-popover');
            const popoverContent = document.getElementById('popover-content');
            let visionHtml = '';
            if (segment.vision_avg.error) {
                visionHtml = `<p class="error" style="margin: 4px 0;">${segment.vision_avg.error}</p>`;
            } else {
                visionHtml = `
                    <div class="pop-row"><span>í‰ê·  ë¯¸ì†Œ:</span> <strong>${segment.vision_avg.smile.toFixed(2)}</strong></div>
                    <div class="pop-row"><span>í‰ê·  ì°¡ê·¸ë¦¼:</span> <strong>${segment.vision_avg.frown.toFixed(2)}</strong></div>
                    <div class="pop-row"><span>í‰ê·  ì‹œì„ (ì¢Œìš°):</span> <strong>${segment.vision_avg.gaze_h.toFixed(2)}</strong></div>
                    <div class="pop-row"><span>í‰ê·  ì‹œì„ (ìƒí•˜):</span> <strong>${segment.vision_avg.gaze_v.toFixed(2)}</strong></div>
                `;
            }

            popoverContent.innerHTML = `
                <h4>"${segment.text.substring(0, 12)}..."</h4>
                <div class="pop-row"><span>ë°œí‘œ ì†ë„(CPS):</span> <strong>${segment.speech_rate_cps.toFixed(2)}</strong></div>
                <div class="pop-row"><span>ëª©ì†Œë¦¬ ë–¨ë¦¼(Jitter):</span> <strong>${segment.prosody.jitter.toFixed(2)}%</strong></div>
                <div class="pop-row"><span>ëª©ì†Œë¦¬ ê±°ì¹ ê¸°(Shimmer):</span> <strong>${segment.prosody.shimmer.toFixed(2)}%</strong></div>
                <hr style="border:0; border-top:1px dashed #555; margin: 8px 0;">
                ${visionHtml}
            `;

            popover.style.display = 'block';
            
            const popWidth = popover.offsetWidth;
            const popHeight = popover.offsetHeight;
            const margin = 10;
            let left = event.clientX + 15;
            let top = event.clientY - 15;
            
            if (left + popWidth + margin > window.innerWidth) {
                left = event.clientX - popWidth - 15;
            }
            if (top + popHeight + margin > window.innerHeight) {
                top = window.innerHeight - popHeight - margin;
            }
             if (top < margin) {
                top = margin;
            }

            popover.style.left = left + 'px';
            popover.style.top = top + 'px';
        }
    </script>
</body>
</html>